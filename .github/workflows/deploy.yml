name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  synth:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for Lambda
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: backend/lambda/package-lock.json

      - name: Install Lambda dependencies
        run: npm ci
        working-directory: backend/lambda

      - name: Build Lambda
        run: npm run build
        working-directory: backend/lambda

      - name: Setup Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: infra/cdk/package-lock.json

      - name: Install CDK dependencies
        run: npm ci
        working-directory: infra/cdk

      - name: CDK Synth
        run: npm run synth
        working-directory: infra/cdk

  deploy:
    needs: synth
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for Lambda
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: backend/lambda/package-lock.json

      - name: Install Lambda dependencies
        run: npm ci
        working-directory: backend/lambda

      - name: Build Lambda
        run: npm run build
        working-directory: backend/lambda

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Setup Node.js for CDK
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: infra/cdk/package-lock.json

      - name: Install CDK dependencies
        run: npm ci
        working-directory: infra/cdk

      - name: CDK Deploy
        id: deploy
        run: |
          npm run cdk -- deploy --require-approval never --outputs-file cdk-outputs.json
          echo "s3-bucket-name=$(jq -r '.CustomerStack.S3BucketName' cdk-outputs.json)" >> $GITHUB_OUTPUT
          echo "cloudfront-id=$(jq -r '.CustomerStack.CloudFrontDistributionId' cdk-outputs.json)" >> $GITHUB_OUTPUT
          echo "api-gateway-url=$(jq -r '.CustomerStack.ApiGatewayUrl' cdk-outputs.json)" >> $GITHUB_OUTPUT
        working-directory: infra/cdk

      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/customer-explorer/package-lock.json

      - name: Install Frontend dependencies
        run: npm ci
        working-directory: frontend/customer-explorer

      - name: Build Frontend
        run: npm run build
        working-directory: frontend/customer-explorer
        env:
          VITE_API_BASE_URL: ${{ steps.deploy.outputs.api-gateway-url }}

      - name: Deploy Frontend to S3
        run: aws s3 sync dist/ s3://${{ steps.deploy.outputs.s3-bucket-name }} --delete
        working-directory: frontend/customer-explorer

      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id ${{ steps.deploy.outputs.cloudfront-id }} --paths "/*"
